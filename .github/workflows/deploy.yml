name: Deploy

on:
  push:
    branches:
      - main

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.detect.outputs.services }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Detect changed services
        id: detect
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          echo "Changed files: $CHANGED_FILES"

          SERVICES=""
          for path in $CHANGED_FILES; do
            if [[ $path == src/*/* ]]; then
              SERVICE=$(echo "$path" | cut -d'/' -f2)
              SERVICES="$SERVICES $SERVICE"
            fi
          done

          UNIQUE_SERVICES=$(echo "$SERVICES" | xargs -n1 | sort -u | xargs)
          echo "Detected services: $UNIQUE_SERVICES"

          # convert to JSON array
          JSON_SERVICES=$(printf '%s\n' $UNIQUE_SERVICES | jq -R . | jq -s .)
          echo "services=$JSON_SERVICES" >> $GITHUB_OUTPUT

  build-and-push:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.services != '' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.services) }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to ECR
        run: |
          aws ecr get-login-password --region ${{ secrets.AWS_REGION }} \
          | docker login --username AWS --password-stdin ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com

      - name: Build and Push Docker image
        if: matrix.service != 'app'
        run: |
          IMAGE_TAG=${{ github.sha }}
          IMAGE=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/retail-store/${{ matrix.service }}:$IMAGE_TAG

          docker build -t $IMAGE ./src/${{ matrix.service }}
          docker push $IMAGE

  update-helm:
    needs: [detect-changes, build-and-push]
    if: ${{ needs.detect-changes.outputs.services != '' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Update Helm values
        run: |
          IMAGE_TAG=${{ github.sha }}
          for service in $(echo '${{ needs.detect-changes.outputs.services }}' | jq -r '.[]'); do
            VALUES_FILE="src/$service/chart/values.yaml"
            if [[ -f "$VALUES_FILE" ]]; then
              echo "Updating $VALUES_FILE with tag $IMAGE_TAG"
              yq -i ".image.tag = \"$IMAGE_TAG\"" "$VALUES_FILE"
            fi
          done

      - name: Commit changes to gitops branch
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          git checkout -B gitops
          git add .
          git commit -m "Update Helm values for ${{ needs.detect-changes.outputs.services }} with tag ${{ github.sha }}" || echo "No changes to commit"
          git push origin gitops --force

  notification:
    needs: update-helm
    runs-on: ubuntu-latest
    steps:
      - name: Notify
        run: echo "âœ… Deployment workflow finished!"
